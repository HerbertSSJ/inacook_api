{% extends "base.html" %}
{% load static %}

{% block title %}Editar Receta - Inacook{% endblock %}

{% block content %}

<div class="container editar-receta-container">

    <h1>Editar Receta: {{ receta.nombre }}</h1>

    <form method="POST" enctype="multipart/form-data" id="receta-form">
        {% csrf_token %}

        {% if receta.imagen %}
        <p><strong>Imagen actual:</strong></p>
            {% if receta.imagen.url %}
                <img id="current-image" src="{{ receta.imagen.url }}" alt="Imagen receta" style="width:300px; border-radius:10px; margin-bottom:15px;">
            {% else %}
                <img id="current-image" src="{{ receta.imagen }}" alt="Imagen receta" style="width:300px; border-radius:10px; margin-bottom:15px;">
            {% endif %}
        {% endif %}

        <h2>Datos de la receta</h2>
        <div class="form-section">
            {{ receta_form.as_p }}
        </div>

        <h2>Ingredientes</h2>

        <div class="ingrediente-form">

            <label>Ingrediente</label>
            <input type="text" id="ingrediente-search" class="form-control" placeholder="Buscar ingrediente...">
            <div id="ingrediente-results" class="search-results" style="position:relative"></div>
            <select id="ingrediente-select" class="form-select" style="display:none;">
                <option value="">Seleccionar</option>
                {% for ingrediente in ingredientes %}
                <option value="{{ ingrediente.id }}" data-precio="{{ ingrediente.costo_unitario }}"
                    data-calidad="{{ ingrediente.calidad }}" data-abrev="{{ ingrediente.unidad_abreviatura }}">
                    {{ ingrediente.nombre }}
                </option>
                {% endfor %}
            </select>

            <label>Cantidad</label>
            <input type="number" step="0.01" id="cantidad-input" class="form-control">

            <label>Peso (por unidad)</label>
            <input type="number" step="0.01" id="peso-input" class="form-control">

            <label>Unidad</label>
            <select id="unidad-select" class="form-select">
                {% for unidad in unidades %}
                <option value="{{ unidad.abreviatura }}">
                    {{ unidad.nombre }} ({{ unidad.abreviatura }})
                </option>
                {% endfor %}
            </select>

            <button type="button" id="add-ingrediente" class="btn btn-primary">Agregar</button>
        </div>

        <table id="ingredientes-table" class="ingredientes-tabla">
            <thead>
                <tr>
                        <th>Ingrediente</th>
                        <th>Cantidad</th>
                        <th>Peso total</th>
                        <th>Unidad</th>
                        <th>Precio</th>
                        <th>Calidad</th>
                        <th>Acción</th>
                    </tr>
            </thead>
            <tbody></tbody>
        </table>

        <input type="hidden" id="ingredientes-json" name="ingredientes_json">

        <button class="btn btn-success mt-3">Guardar Cambios</button>
        <a href="{% url 'ver_recetas' %}" class="btn btn-secondary mt-3">Cancelar</a>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>

    const ingredientesBD = JSON.parse("{{ ingredientes_bd_json|escapejs }}");
    let ingredientesLista = JSON.parse("{{ receta_ingredientes_json|escapejs }}");


    const tablaBody = document.querySelector("#ingredientes-table tbody");
    const ingredientesJson = document.getElementById("ingredientes-json");

    
    const selectIngrediente = document.getElementById('ingrediente-select');
    const ingredienteSearch = document.getElementById('ingrediente-search');
    const ingredienteResults = document.getElementById('ingrediente-results');

    function buildSearchResults() {
        const q = ingredienteSearch.value.trim().toLowerCase();
        ingredienteResults.innerHTML = '';
        if (!q) return;
        const options = Array.from(selectIngrediente.querySelectorAll('option'))
            .filter(opt => opt.value !== '' && opt.textContent.toLowerCase().includes(q));

        const list = document.createElement('ul');
        list.style.listStyle = 'none';
        list.style.margin = 0;
        list.style.padding = '4px';
        list.style.background = '#222';
        list.style.border = '1px solid #444';
        list.style.maxHeight = '180px';
        list.style.overflow = 'auto';

        options.slice(0, 12).forEach(opt => {
            const li = document.createElement('li');
            li.textContent = opt.textContent.trim();
            li.dataset.value = opt.value;
            li.style.padding = '6px 8px';
            li.style.cursor = 'pointer';
            li.style.color = '#fff';
            li.onmouseenter = () => li.style.background = '#333';
            li.onmouseleave = () => li.style.background = 'transparent';
            li.onclick = () => {
                selectIngrediente.value = li.dataset.value;
                ingredienteSearch.value = li.textContent;
                ingredienteResults.innerHTML = '';
            };
            list.appendChild(li);
        });
        ingredienteResults.appendChild(list);
    }

    ingredienteSearch.addEventListener('input', buildSearchResults);
    document.addEventListener('click', (e) => {
        if (!ingredienteResults.contains(e.target) && e.target !== ingredienteSearch) {
            ingredienteResults.innerHTML = '';
        }
    });

    let ingredientesReceta = ingredientesLista;

    renderTabla();

    
    (function() {
        const form = document.getElementById('receta-form');
        if (!form) return;
        const fileInput = form.querySelector('input[type=file]');
        if (!fileInput) return;
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            let img = document.getElementById('current-image');
            if (!img) {
                const p = document.createElement('p');
                p.innerHTML = '<strong>Imagen seleccionada:</strong>';
                img = document.createElement('img');
                img.id = 'current-image';
                img.style.width = '300px';
                img.style.borderRadius = '10px';
                img.style.marginBottom = '15px';
                p.appendChild(img);
                form.insertBefore(p, form.firstChild);
            }
            img.src = URL.createObjectURL(file);
        });
    })();

    function renderTabla() {


document.getElementById('receta-form').addEventListener('submit', function(e) {
    const ok = confirm('Al guardar los cambios se eliminarán las relaciones de ingredientes existentes y se crearán las nuevas. ¿Deseas continuar?');
    if (!ok) e.preventDefault();
});

        tablaBody.innerHTML = "";

        ingredientesReceta.forEach((ing, i) => {
            const pesoTotal = (ing.peso_total !== undefined && ing.peso_total !== null) ? ing.peso_total : '-';
            tablaBody.innerHTML += `
            <tr>
                <td>${ing.nombre}</td>
                <td>${ing.cantidad}</td>
                <td>${pesoTotal}</td>
                <td>${ing.unidad}</td>
                <td>$${ing.precio}</td>
                <td>${ing.calidad}</td>
                <td><button class="btn btn-danger eliminar" data-i="${i}">Eliminar</button></td>
            </tr>
        `;
        });

        document.querySelectorAll(".eliminar").forEach(btn => {
            btn.onclick = e => {
                ingredientesReceta.splice(e.target.dataset.i, 1);
                renderTabla();
            };
        });

        ingredientesJson.value = JSON.stringify(ingredientesReceta);
    }


    document.getElementById("add-ingrediente").onclick = () => {
        const id = document.getElementById("ingrediente-select").value;
        const cantidad = document.getElementById("cantidad-input").value;
        const unidad = document.getElementById("unidad-select").value;
        const peso = parseFloat(document.getElementById('peso-input').value || 0);

        if (!id) return alert("Debes seleccionar un ingrediente.");
        if (!cantidad || cantidad <= 0) return alert("Cantidad inválida");

        const d = ingredientesBD[id];

        const peso_total = peso > 0 ? (peso * parseFloat(cantidad)) : null;

    
        const select = document.getElementById('ingrediente-select');
        const selectedOption = select.selectedOptions[0];
        const originalAbrev = selectedOption ? selectedOption.dataset.abrev : '';
        if (originalAbrev && unidad && originalAbrev !== unidad) {
            const ok = confirm(`Este ingrediente fue creado con la unidad de medida '${originalAbrev}'.\n¿Deseas agregarlo con la unidad '${unidad}' igualmente? (Aceptar = sí, Cancelar = no)`);
            if (!ok) return;
        }

    
        const existingIndex = ingredientesLista.findIndex(it => it.id == id && it.unidad == unidad);
        if (existingIndex !== -1) {
            const existing = ingredientesLista[existingIndex];
            const newCantidad = parseFloat(existing.cantidad) + parseFloat(cantidad);
            existing.cantidad = Number.isInteger(newCantidad) ? newCantidad : parseFloat(newCantidad.toFixed(2));
            if (peso > 0) {
                existing.peso = peso;
                existing.peso_total = parseFloat((peso * existing.cantidad).toFixed(2));
            } else {
                if (existing.peso) {
                    existing.peso_total = parseFloat((existing.peso * existing.cantidad).toFixed(2));
                } else {
                    existing.peso_total = null;
                }
            }
        } else {
            ingredientesLista.push({
                id,
                nombre: d.nombre,
                cantidad,
                peso: peso > 0 ? peso : null,
                peso_total: peso_total,
                unidad,
                precio: d.precio,
                calidad: d.calidad
            });
        }

        renderTabla();
    };


    renderTabla();
</script>

{% endblock %}