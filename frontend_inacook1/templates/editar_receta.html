{% extends "base.html" %}
{% load static %}

{% block title %}Editar Receta - Inacook{% endblock %}

{% block content %}

<div class="container editar-receta-container">

    <h1>Editar Receta: {{ receta.nombre }}</h1>

    <form method="POST" enctype="multipart/form-data" id="receta-form">
        {% csrf_token %}

        {% if receta.imagen %}
        <p><strong>Imagen actual:</strong></p>
        <img src="{{ receta.imagen }}" style="width:300px; border-radius:10px; margin-bottom:15px;">
        {% endif %}

        <h2>Datos de la receta</h2>
        <div class="form-section">
            {{ receta_form.as_p }}
        </div>

        <h2>Ingredientes</h2>

        <div class="ingrediente-form">

            <label>Ingrediente</label>
            <select id="ingrediente-select" class="form-select">
                <option value="">Seleccionar</option>
                {% for ingrediente in ingredientes %}
                <option value="{{ ingrediente.id }}" data-precio="{{ ingrediente.costo_unitario }}"
                    data-calidad="{{ ingrediente.calidad }}" data-abrev="{{ ingrediente.unidad_abreviatura }}">
                    {{ ingrediente.nombre }}
                </option>
                {% endfor %}
            </select>

            <label>Cantidad</label>
            <input type="number" step="0.01" id="cantidad-input" class="form-control">

            <label>Unidad</label>
            <select id="unidad-select" class="form-select">
                {% for unidad in unidades %}
                <option value="{{ unidad.abreviatura }}">
                    {{ unidad.nombre }} ({{ unidad.abreviatura }})
                </option>
                {% endfor %}
            </select>

            <button type="button" id="add-ingrediente" class="btn btn-primary">Agregar</button>
        </div>

        <table id="ingredientes-table" class="ingredientes-tabla">
            <thead>
                <tr>
                    <th>Ingrediente</th>
                    <th>Cantidad</th>
                    <th>Unidad</th>
                    <th>Precio</th>
                    <th>Calidad</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <input type="hidden" id="ingredientes-json" name="ingredientes_json">

        <button class="btn btn-success mt-3">Guardar Cambios</button>
        <a href="{% url 'ver_recetas' %}" class="btn btn-secondary mt-3">Cancelar</a>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>

    const ingredientesBD = JSON.parse("{{ ingredientes_bd_json|escapejs }}");
    let ingredientesLista = JSON.parse("{{ receta_ingredientes_json|escapejs }}");


    const tablaBody = document.querySelector("#ingredientes-table tbody");
    const ingredientesJson = document.getElementById("ingredientes-json");

    let ingredientesReceta = ingredientesLista;

    renderTabla();

    function renderTabla() {
        tablaBody.innerHTML = "";

        ingredientesReceta.forEach((ing, i) => {
            tablaBody.innerHTML += `
            <tr>
                <td>${ing.nombre}</td>
                <td>${ing.cantidad}</td>
                <td>${ing.unidad}</td>
                <td>$${ing.precio}</td>
                <td>${ing.calidad}</td>
                <td><button class="btn btn-danger eliminar" data-i="${i}">Eliminar</button></td>
            </tr>
        `;
        });

        document.querySelectorAll(".eliminar").forEach(btn => {
            btn.onclick = e => {
                ingredientesReceta.splice(e.target.dataset.i, 1);
                renderTabla();
            };
        });

        ingredientesJson.value = JSON.stringify(ingredientesReceta);
    }


    document.getElementById("add-ingrediente").onclick = () => {
        const id = document.getElementById("ingrediente-select").value;
        const cantidad = document.getElementById("cantidad-input").value;
        const unidad = document.getElementById("unidad-select").value;

        if (!id) return alert("Debes seleccionar un ingrediente.");
        if (!cantidad || cantidad <= 0) return alert("Cantidad inválida");

        const d = ingredientesBD[id];

        ingredientesLista.push({
            id,
            nombre: d.nombre,
            cantidad,
            unidad,
            precio: d.precio,
            calidad: d.calidad
        });

        renderTabla();
    };


    renderTabla();
</script>

{% endblock %}