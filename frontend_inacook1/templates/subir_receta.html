{% extends "base.html" %}
{% load static %}

{% block title %}Subir Receta - Inacook{% endblock %}

{% block content %}
<div class="container subir-receta-container">

    <h1>Subir nueva receta</h1>

    <form method="POST" enctype="multipart/form-data" id="receta-form">
        {% csrf_token %}

        <h2>Datos de la receta</h2>
        <div class="form-section">
            {{ receta_form.as_p }}
        </div>

        <h2>Ingredientes</h2>

        <div class="ingrediente-form">

            <label for="ingrediente-select">Ingrediente:</label>
            <select id="ingrediente-select" class="form-select">
                <option value="">Selecciona un ingrediente</option>
                {% for ingrediente in ingredientes %}
                <option value="{{ ingrediente.id }}" data-precio="{{ ingrediente.costo_unitario }}"
                    data-calidad="{{ ingrediente.calidad }}">
                    {{ ingrediente.nombre }}
                </option>
                {% endfor %}
            </select>

            <label for="cantidad-input">Cantidad:</label>
            <input type="number" step="0.01" id="cantidad-input" placeholder="Cantidad" class="form-control">

            <label for="unidad-select">Unidad de Medición:</label>
            <select id="unidad-select" class="form-select">
                <option value="">Selecciona una unidad</option>
                {% for unidad in unidades %}
                <option value="{{ unidad.nombre }}">
                    {{ unidad.nombre }} ({{ unidad.abreviatura }})
                </option>
                {% endfor %}
            </select>

            <button type="button" id="add-ingrediente" class="btn btn-primary">
                AGREGAR
            </button>
        </div>

        <table id="ingredientes-table" class="ingredientes-tabla">
            <thead>
                <tr>
                    <th>Ingrediente</th>
                    <th>Cantidad</th>
                    <th>Unidad</th>
                    <th>Precio</th>
                    <th>Calidad</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <input type="hidden" name="ingredientes_json" id="ingredientes-json">

        <div class="form-actions">
            <button type="submit" class="btn btn-success">SUBIR RECETA</button>
        </div>
    </form>
</div>

{% block scripts %}
<script>
    const selectIngrediente = document.getElementById('ingrediente-select');
    const cantidadInput = document.getElementById('cantidad-input');
    const unidadSelect = document.getElementById('unidad-select');
    const addBtn = document.getElementById('add-ingrediente');
    const tableBody = document.querySelector('#ingredientes-table tbody');
    const ingredientesJson = document.getElementById('ingredientes-json');

    let ingredientesLista = [];

    function renderizarTabla() {
        tableBody.innerHTML = '';

        ingredientesLista.forEach((ing, idx) => {
            const row = document.createElement('tr');

            row.innerHTML = `
            <td>${ing.nombre}</td>
            <td>${ing.cantidad}</td>
            <td>${ing.unidad}</td>
            <td>$${ing.precio}</td>
            <td>${ing.calidad}</td>
            <td>
                <button type="button" data-idx="${idx}" class="btn btn-secondary eliminar-btn">
                    Eliminar
                </button>
            </td>
        `;

            tableBody.appendChild(row);
        });

        document.querySelectorAll(".eliminar-btn").forEach(boton => {
            boton.addEventListener("click", (e) => {
                const index = e.target.dataset.idx;
                ingredientesLista.splice(index, 1);
                renderizarTabla();
            });
        });

        ingredientesJson.value = JSON.stringify(ingredientesLista);
    }

    addBtn.addEventListener("click", () => {

        const selectedOption = selectIngrediente.selectedOptions[0];

        if (!selectedOption)
            return mostrarError("Selecciona un ingrediente.");

        const id = selectedOption.value;
        const nombre = selectedOption.text;
        const precio = parseFloat(selectedOption.dataset.precio || 0);
        const calidad = selectedOption.dataset.calidad || "";

        const cantidad = parseFloat(cantidadInput.value);
        const unidad = unidadSelect.value;

        if (!cantidad || cantidad <= 0)
            return mostrarError("Cantidad inválida.");

        if (!unidad)
            return mostrarError("Selecciona una unidad.");

        ingredientesLista.push({
            id,
            nombre,
            cantidad,
            unidad,
            precio,
            calidad
        });

        renderizarTabla();

        cantidadInput.value = "";
        unidadSelect.value = "";
        selectIngrediente.value = "";
    });

    function mostrarError(msg) {
        const error = document.createElement("p");
        error.style.color = "red";
        error.textContent = msg;
        document.querySelector(".ingrediente-form").appendChild(error);

        setTimeout(() => error.remove(), 2500);
    }
</script>
{% endblock %}
{% endblock %}